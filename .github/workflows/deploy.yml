name: Build & Deploy React (Nginx container on new port)

on:
  push:
    branches: [ "main" ]  # Ù‡Ø± Ø¨Ø§Ø± Ú©Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ù‡ Ø´Ø§Ø®Ù‡ Ø§ØµÙ„ÛŒ push Ø´ÙˆØ¯ØŒ Ø§ÛŒÙ† workflow Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯.

permissions:
  contents: read  # Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† repository
  packages: write  # Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ´ØªÙ† Ø¨Ù‡ GHCR

env:
  IMAGE_NAME: react-app  # Ù†Ø§Ù… Docker image
  GHCR_OWNER: gavinruff007  # ØµØ§Ø­Ø¨ image Ø¯Ø± GHCR (GitHub Container Registry)

jobs:
  build-and-push:
    name: ğŸ—ï¸ Build & Push Docker Image
    runs-on: ubuntu-latest  # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„ Ubuntu Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„

    steps:
      - name: ğŸ”¹ Checkout repository
        uses: actions/checkout@v4  # Ú¯Ø§Ù… Ø§ÙˆÙ„: Ú†Ú© Ú©Ø±Ø¯Ù† repository

      - name: ğŸ” Create .env.production from secrets
        run: |
          echo "REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}" > .env.production  # Ø³Ø§Ø®Øª .env.production Ø§Ø² secrets

      - name: ğŸ”¹ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3  # ØªÙ†Ø¸ÛŒÙ… Ø§Ø¨Ø²Ø§Ø± Buildx Ø¨Ø±Ø§ÛŒ Docker

      - name: ğŸ”¹ Login to GHCR (push)
        uses: docker/login-action@v3  # ÙˆØ±ÙˆØ¯ Ø¨Ù‡ GHCR Ø¨Ø±Ø§ÛŒ push
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_OWNER }}
          password: ${{ secrets.GITHUB_TOKEN }}  # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² token Ø¨Ø±Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª

      - name: ğŸ”¹ Build & Push image (as latest)
        uses: docker/build-push-action@v6  # Ú¯Ø§Ù… Ø¨Ø¹Ø¯ÛŒ: Ø³Ø§Ø®Øª Docker image Ùˆ push Ø¨Ù‡ GHCR
        with:
          context: .  # Ù…Ø³ÛŒØ± Ù¾Ø±ÙˆÚ˜Ù‡
          push: true  # Ø§Ø±Ø³Ø§Ù„ image Ø¨Ù‡ registry
          tags: ghcr.io/${{ env.GHCR_OWNER }}/${{ env.IMAGE_NAME }}:latest  # ØªÚ¯ Ú©Ø±Ø¯Ù† Ø¨Ø§ Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡
          cache-from: type=gha  # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² cache Ø§Ø² GitHub Actions
          cache-to: type=gha,mode=max  # Ø°Ø®ÛŒØ±Ù‡ cache Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ

  deploy:
    name: ğŸš€ Deploy to Server
    runs-on: ubuntu-latest  # Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Ubuntu Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    needs: build-and-push  # Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² build-and-push Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯

    steps:
      - name: ğŸ”¸ SSH into server and deploy latest image
        uses: appleboy/ssh-action@v1.2.0  # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² SSH Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ùˆ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ù¾Ø±ÙˆÚ˜Ù‡
        with:
          host: ${{ secrets.SSH_HOST }}  # Ø¢Ø¯Ø±Ø³ IP ÛŒØ§ DNS Ø³Ø±ÙˆØ±
          username: ${{ secrets.SSH_USER }}  # Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ SSH
          key: ${{ secrets.SSH_PRIVATE_KEY }}  # Ú©Ù„ÛŒØ¯ Ø®ØµÙˆØµÛŒ SSH
          port: 9011  # Ù¾ÙˆØ±Øª SSH Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
          script: |
            set -e

            echo "ğŸ” Logging in to GHCR..."
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "gavinruff007" --password-stdin  # ÙˆØ±ÙˆØ¯ Ø¨Ù‡ GHCR Ø¨Ø±Ø§ÛŒ Ú©Ø´ÛŒØ¯Ù† image

            echo "ğŸ“‚ Changing directory to /home/deploy/react-app..."
            cd /home/deploy/react-app || { echo "âŒ Directory not found!"; exit 1; }

            echo "ğŸ” Checking for docker-compose.yml..."
            if [ ! -f docker-compose.yml ]; then
              echo "âŒ docker-compose.yml not found in /home/deploy/react-app"
              exit 1
            fi

            echo "ğŸ“ Ensuring lowercase GHCR path..."
            sed -i 's#ghcr.io/.*/react-app:.*#ghcr.io/gavinruff007/react-app:latest#g' docker-compose.yml  # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ path Ø¯Ø± ÙØ§ÛŒÙ„ docker-compose

            echo "âš™ï¸ Detecting Docker Compose command..."
            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"  # Ø§Ú¯Ø± Docker Compose Ù†ØµØ¨ Ø§Ø³Øª
            elif command -v docker-compose >/dev/null 2>&1; then
              COMPOSE="docker-compose"  # Ø§Ú¯Ø± Ù†Ø³Ø®Ù‡ Ù‚Ø¯ÛŒÙ…ÛŒ Docker Compose Ù†ØµØ¨ Ø§Ø³Øª
            else
              echo "âŒ Docker Compose not installed! Install it with:"
              echo "sudo apt install docker-compose -y"
              exit 1
            fi

            echo "â¬‡ï¸ Pulling latest image..."
            $COMPOSE pull  # Ú©Ø´ÛŒØ¯Ù† Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Docker image Ø§Ø² GHCR

            echo "ğŸš€ Starting container..."
            $COMPOSE up -d  # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ container Ø¨Ù‡ ØµÙˆØ±Øª detached

            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=24h" || true  # Ø­Ø°Ù ØªØµØ§ÙˆÛŒØ± Ù‚Ø¯ÛŒÙ…ÛŒ Docker

            echo "âœ… Deployment completed successfully!"  # Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø³ØªÙ‚Ø±Ø§Ø±
